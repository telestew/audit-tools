# from https://www.google.com/search?q=release+chrome+extension+zip+and+webstore+github+action&rlz=1CAKWVH_enUS1146US1146&gs_lcrp=EgZjaHJvbWUyBggAEEUYOTIHCAEQIRigATIHCAIQIRigATIHCAMQIRigATIHCAQQIRirAjIHCAUQIRiPAtIBCDk1MTBqMGo3qAIAsAIA&sourceid=chrome&ie=UTF-8&udm=50&fbs=AIIjpHxU7SXXniUZfeShr2fp4giZud1z6kQpMfoEdCJxnpm_3W-pLdZZVzNY_L9_ftx08kxElMEpo90JBBY0TEXYKcN_IwOPyE5tikuTlZNNw-umcbJxSDffR92FBO_sVFIn0cRVPgyQ0qNm9FOK_KicZnqXAi1wQnet-YTzXXFMkYUZ2rV6urDX1YuaR_drlEyA91i4HH-p5dD_cV90I9KyGSbzO3FCmQ&ved=2ahUKEwiCqdaisoaPAxUxCjQIHVUIOLYQ0NsOegQIVxAA&aep=10&ntc=1&mstk=AUtExfAnCUG9v4jxKG4tjeeCLXrwpgkxUkuV2RzxBPMfdrf99ESGPf2TpF7Grkon3821YEQZVV0e5DYcXeq8B_bI4HdVNdw6kuTYfjDQNd20sIIeJInT_mzZbjc633TDY9dwbfrm8WUn1jI_MtHOGgaL9qeZ_jRnmvrmwLXhOgrp2c3wNONRaGVtGB_89kJJcOH9QYUqBWEHleFg6yTk-fkORm1bOqUm4_Bx6rphKHVXTFFYKGoH2uFRH1WqFw&csuir=1
name: Release Chrome Extension and Create GitHub Release

on:
  push:
    tags:
      - 'v*' # Trigger on push of tags like v1.0.0, v1.2.3, etc.

jobs:
  build_publish_release:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    # Optional: If your extension requires a build step (e.g., using React, Vue, etc.)
    # - name: Setup Node.js
    #   uses: actions/setup-node@v3
    #   with:
    #     node-version: '18' # Adjust as needed for your project

    # - name: Install dependencies
    #   run: npm install

    # - name: Build extension
    #   run: npm run build # Adjust build command as needed

    - name: Extract version from tag
      id: get_version # Give this step an ID to reference its outputs
      run: echo "VERSION=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT # Extracts the version (e.g., "1.0.0" from "v1.0.0")

    - name: Package extension as zip
      run: |
        zip -r audit-tools-${{ steps.get_version.outputs.VERSION }}.zip ./ # Adjust path to your extension's build output and use the extracted version

    - name: Publish Chrome Extension
      uses: browser-actions/release-chrome-extension@latest
      with:
        extension-id: ${{ secrets.EXTENSION_ID }}
        extension-path: 'audit-tools-${{ steps.get_version.outputs.VERSION }}.zip' # Use the generated zip file name
        oauth-client-id: ${{ secrets.OAUTH_CLIENT_ID }}
        oauth-client-secret: ${{ secrets.OAUTH_CLIENT_SECRET }}
        oauth-refresh-token: ${{ secrets.OAUTH_REFRESH_TOKEN }}
        # action: 'publish' # Optional: Set to 'publish' for automatic submission, default is 'upload'
        # target: 'default' # Optional: Set to 'trustedUsers' for publishing to testers, default is 'default'

    - name: Create GitHub Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref }}
        release_name: Release ${{ github.ref }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./audit-tools-${{ steps.get_version.outputs.VERSION }}.zip # Path to the generated zip file
        asset_name: audit-tools-${{ steps.get_version.outputs.VERSION }}.zip # Use the generated zip file name for the asset
        asset_content_type: application/zip
